import { getBrowserInstance } from '../../../hooks/chromium'; import { jwtsign } from '../../../hooks/jwt'; import { serialize } from 'cookie'; const jea = { login: 'https://jovenes.prosperidadsocial.gov.co/JeA/App/Autenticacion/Ingreso.aspx' }; export default async function handler (t, e) { const { txtLogin: o, txtPassword: n } = t.body; if (!o && !n) return e.status(401).json({ error: 'txtLogin & txtPassword is null' }); const s = { __EVENTTARGET: '', __EVENTARGUMENT: '', __VIEWSTATE: '/wEPDwUKMTgzMTkwNjU5N2RkBzRfMAiOYq+2C5xb/CKcUKIc0tteUaD5VsGtBdniwOw=', __VIEWSTATEGENERATOR: '5FB187ED', __EVENTVALIDATION: '/wEdAAVkLbFzMJkj2q5ajQFnB1/Nxcn6oIDdbNQI5AQUIIyv4nY2+Mc6SrnAqio3oCKbxYbhmcUwnnAqzH7wP2sLpdBP5S6DA253Jb+lVAXUo1bJz6namLqidyxo2qXDrxuDEDt4cCYQJnlXam9t00UTah+n', BtnEntrar: 'Entrar', txtLogin: o, txtPassword: n }; let a = null; try { a = await getBrowserInstance(); const t = await a.newPage(); t.setDefaultNavigationTimeout(0), t.setRequestInterception(!0), t.on('request', t => { t.continue({ method: 'POST', postData: new URLSearchParams(s).toString(), headers: { ...t.headers(), 'Content-Type': 'application/x-www-form-urlencoded' } }) }), await t.goto(jea.login); const o = await t.evaluate(() => { try { const t = document.querySelector('#panelMensajes').textContent.trim(); return { code: !t, message: t } } catch (t) { return { code: !0, message: 'Login success' } } }); if (o.code) { const o = await t.cookies(); const n = jwtsign(o); const s = serialize('jeaNext', n, { httpOnly: !0, secure: process.env.NODE_ENV === 'production', sameSite: 'strict', maxAge: 2592e6, path: '/' }); e.setHeader('Set-Cookie', s) } return a.close(), e.status(200).json(o) } catch (t) { console.log(t), e.json({ status: 'error', data: t.message || 'Algo sali√≥ mal' }) } finally { a !== null && await a.close() } }
